# ğŸ—ï¸ Code Puppy - Technical Architecture

**Version**: 2.0 (BART System - Belief-Augmented Reasoning & Tasking)  
**Date**: January 31, 2026  
**Status**: Production-Ready

---

## ğŸ“‹ Table of Contents

- [ğŸ—ï¸ Code Puppy - Technical Architecture](#ï¸-code-puppy---technical-architecture)
  - [ğŸ“‹ Table of Contents](#-table-of-contents)
  - [High-Level Overview](#high-level-overview)
    - [Key Principles](#key-principles)
  - [System Architecture Diagram](#system-architecture-diagram)
  - [Core Components](#core-components)
    - [Component Registry](#component-registry)
  - [Model Tier Hierarchy](#model-tier-hierarchy)
    - [Routing Logic](#routing-logic)
  - [BART Orchestration System](#bart-orchestration-system)
    - [The Reasoning \& Tasking Architecture](#the-reasoning--tasking-architecture)
    - [Pydantic Models](#pydantic-models)
  - [Cerebras GLM 4.7 Optimization](#cerebras-glm-47-optimization)
    - [The 10 Rules Implementation](#the-10-rules-implementation)
    - [API Parameters](#api-parameters)
  - [Agent System](#agent-system)
    - [Agent Hierarchy](#agent-hierarchy)
    - [Agent Tools](#agent-tools)
  - [MCP Infrastructure](#mcp-infrastructure)
    - [Server Lifecycle](#server-lifecycle)
  - [Token Budget \& Cost Management](#token-budget--cost-management)
    - [Rate Limiting Architecture](#rate-limiting-architecture)
    - [Cost Tracking](#cost-tracking)
  - [Messaging \& Event System](#messaging--event-system)
    - [Bidirectional Communication](#bidirectional-communication)
  - [Plugin Architecture](#plugin-architecture)
    - [Hook System](#hook-system)
    - [Available Plugins](#available-plugins)
  - [Data Flow Diagrams](#data-flow-diagrams)
    - [User Request â†’ Response](#user-request--response)
  - [File Structure Summary](#file-structure-summary)
  - [Observability](#observability)
    - [Logfire Integration](#logfire-integration)
    - [Metrics Tracked](#metrics-tracked)
  - [Version History](#version-history)

---

## High-Level Overview

Code Puppy implements the **BART System (Belief-Augmented Reasoning & Tasking)** - a Traycer-style architecture that implements Plan â†’ Execute â†’ Verify loop for AI-assisted coding. The system coordinates multiple specialized AI models through a tiered routing system, with bidirectional verification to prevent agent drift.

### Key Principles

- **Belief-Augmented Reasoning**: Separating the 'Belief State' (Truth) from the 'Execution State' (Code)
- **Tiered Model Routing**: Right model for the right task
- **Bidirectional Verification**: The 'Ralph Loop' validates output against belief, not just syntax
- **Token Budget Governance**: Prevent 429s with smart rate limiting
- **Logfire Observability**: Full tracing of all operations

---

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    CODE PUPPY v2.0                                       â”‚
â”‚                     BART System (Belief â€¢ Augmented â€¢ Reasoning â€¢ Tasking)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           USER INTERFACE LAYER                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â”‚
â”‚  â”‚  â”‚    CLI     â”‚  â”‚    API     â”‚  â”‚  WebSocket â”‚  â”‚   PTY      â”‚                â”‚   â”‚
â”‚  â”‚  â”‚ (Textual)  â”‚  â”‚  (FastAPI) â”‚  â”‚  Realtime  â”‚  â”‚  Manager   â”‚                â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚               â”‚               â”‚               â”‚                            â”‚
â”‚           â–¼               â–¼               â–¼               â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          MESSAGING / EVENT BUS                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚  MessageBus  â”‚  â”‚  Renderers   â”‚  â”‚   Spinner    â”‚  â”‚ QueueConsole â”‚        â”‚   â”‚
â”‚  â”‚  â”‚  (Bidirect)  â”‚  â”‚  (Rich/MD)   â”‚  â”‚   System     â”‚  â”‚              â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                              â”‚
â”‚                                         â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   ğŸ§  BELIEF & REASONING LAYER (The Brain)                       â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                     EpistemicStateArtifact                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Goals   â”‚ â”‚ Hypotheses â”‚ â”‚Assumptionsâ”‚ â”‚  Gaps   â”‚ â”‚ Constraints â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Epics  â”‚ â”‚   Phases   â”‚ â”‚ Milestonesâ”‚ â”‚Checkpts â”‚                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                    â”‚                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                              â”‚   â”‚
â”‚  â”‚  â”‚   PLAN      â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  â”‚ (Opus 4.5)  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚     VERIFY      â”‚â”‚
â”‚  â”‚  â”‚             â”‚                                              â”‚  (Ralph Loop)   â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Interview â”‚                                              â”‚ â€¢ Static Anal.  â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Decompose â”‚                                              â”‚ â€¢ Drift Detect  â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Plan Epicsâ”‚                                              â”‚ â€¢ Spec Check    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”‚         â”‚                                                              â”‚         â”‚
â”‚  â”‚         â”‚              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Retry if FAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”‚         â”‚ Context Filter (Curated PRDs, Specs, Constraints)                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚            â”‚                                                                          â”‚
â”‚            â–¼                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   ğŸ¤š TASKING & EXECUTION LAYER (The Hands)                      â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚   â”‚
â”‚  â”‚  â”‚    EXECUTE      â”‚            Evidence/Code â–²                                â”‚   â”‚
â”‚  â”‚  â”‚  (Cerebras GLM) â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ ContextCuratorâ”‚                                                           â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ HuskyExecutionâ”‚                                                           â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ TaskDecomposerâ”‚                                                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                              â”‚
â”‚                                         â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                            ğŸ”€ MODEL ROUTER                                       â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                      Tier Hierarchy (February 2026)                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Tier 1 â”€â”€â”€â”€â”€â–º Claude Opus 4.5 â”€â”€â”€â”€â”€â”€â–º Planning, Security, QA           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Architect)   Kimi K2.5 (1T MoE)      Conflict Resolution              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚               Qwen3-235B-Thinking      Complex Orchestration            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Tier 2 â”€â”€â”€â”€â”€â–º GPT-5.2-Codex â”€â”€â”€â”€â”€â”€â”€â”€â–º Complex Logic, Refactoring       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Builder-Hi)  DeepSeek R1-0528        Agentic Coding (400K ctx)        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚               Kimi K2-Thinking         Algorithm Implementation          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Tier 3 â”€â”€â”€â”€â”€â–º Claude Sonnet 4.5 â”€â”€â”€â”€â–º Class Design, API Design         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Builder-Mid) MiniMax M2.1 (1M ctx)   Code Review, Standard Dev        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚               Gemini 3 Pro             All-rounder Development          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Tier 4 â”€â”€â”€â”€â”€â–º Gemini 3 Flash â”€â”€â”€â”€â”€â”€â”€â–º Context Search, Summarization    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Librarian)   Claude Haiku 4.5        Log Analysis, Documentation       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚               OpenRouter Free Models   Cost-effective Context           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Tier 5 â”€â”€â”€â”€â”€â–º Cerebras GLM 4.7 â”€â”€â”€â”€â”€â–º Code Gen, Tests, Linting         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Sprinter)    (358B MoE, 1500+ t/s)   Boilerplate, Syntax Fixing        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Task Complexity Analysis                                               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ LOW â”€â”€â”€â”€â”€â”€â”€â–º Sprinter (Cerebras)                                     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ MEDIUM â”€â”€â”€â”€â–º Librarian (Gemini) or Builder (Codex)                   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ HIGH â”€â”€â”€â”€â”€â”€â–º Builder (Sonnet) or Architect (Opus)                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ CRITICAL â”€â”€â–º Architect (Opus) always                                 â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                              â”‚
â”‚                                         â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         ğŸ’° TOKEN BUDGET MANAGER                                  â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚  Cerebras   â”‚  â”‚   Gemini    â”‚  â”‚  Anthropic  â”‚  â”‚   OpenAI    â”‚            â”‚   â”‚
â”‚  â”‚  â”‚ 300K/min    â”‚  â”‚ ~100K/min   â”‚  â”‚ ~100K/min   â”‚  â”‚ ~100K/min   â”‚            â”‚   â”‚
â”‚  â”‚  â”‚ 24M/day     â”‚  â”‚ ~2M/day     â”‚  â”‚ ~1M/day     â”‚  â”‚ ~1M/day     â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚  Synthetic  â”‚  â”‚   Kimi      â”‚  â”‚  DeepSeek   â”‚  â”‚  OpenRouter â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  30/min     â”‚  â”‚ 60K/min     â”‚  â”‚ 60K/min     â”‚  â”‚ Free tier   â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  (HF tier)  â”‚  â”‚ ~500K/day   â”‚  â”‚ ~500K/day   â”‚  â”‚ Limited     â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ Cost Tracking (genai-prices)                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Per-request cost estimation                                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Budget alerts and limits                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Real-time cost dashboard                                               â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                              â”‚
â”‚                                         â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           ğŸ¤– AGENT SYSTEM                                        â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚                          BaseAgent (ABC)                                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Pydantic-AI integration (DBOSAgent for durability)                     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Tool registration & execution                                          â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Context compression & token management                                 â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Logfire tracing & callbacks                                            â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                         â”‚                                       â”‚   â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚         â–¼                               â–¼                               â–¼       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                        SPECIALIZED AGENTS                               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   Pack Leader ğŸº     â”‚  â”‚   Code Puppy ğŸ•      â”‚                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   (Orchestrator)     â”‚  â”‚   (Main Agent)       â”‚                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                      THE PACK ğŸ•                                  â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚Bloodhound â”‚ â”‚  Terrier  â”‚ â”‚   Husky   â”‚ â”‚ Shepherd  â”‚        â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚(bd issues)â”‚ â”‚(worktrees)â”‚ â”‚(execution)â”‚ â”‚ (review)  â”‚        â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ Watchdog  â”‚ â”‚ Retriever â”‚                                     â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  (QA)     â”‚ â”‚ (merging) â”‚                                     â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                    SPECIALIST AGENTS                              â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ Python Rev. â”‚ â”‚  TS Rev.    â”‚ â”‚  Go Rev.    â”‚ â”‚  C/C++ Rev. â”‚â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ QA Expert   â”‚ â”‚ Security    â”‚ â”‚ Planning    â”‚ â”‚ Epistemic   â”‚â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚             â”‚ â”‚ Auditor     â”‚ â”‚ Agent       â”‚ â”‚ Architect   â”‚â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                              â”‚
â”‚                                         â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                            ğŸ”§ TOOLS LAYER                                        â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ File Operations          Command Execution        Token Management      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ read_file              â€¢ agent_run_shell        â€¢ TokenBudgetGuard    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ write_file             â€¢ ShellGovernor          â€¢ TokenSlimmer        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ list_files             â€¢ CommandRunner          â€¢ IOBudgetEnforcer    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ grep                                            â€¢ ContextLoader       â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Agent Tools              Display Tools            Cerebras Optimizer    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ invoke_agent           â€¢ agent_display          â€¢ GLMPromptOptimizer  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ list_agents            â€¢ share_reasoning        â€¢ TaskDecomposer      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ subagent_context       â€¢ router_hooks           â€¢ CerebrasGLMSettings â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                              â”‚
â”‚                                         â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          ğŸ”Œ MCP INFRASTRUCTURE                                   â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                         MCPManager                                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Server lifecycle management                                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Pydantic-AI compatibility                                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Circuit breaker integration                                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Health monitoring                                                     â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                         â”‚                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ ManagedServerâ”‚  â”‚ ServerReg.  â”‚  â”‚ StatusTrackerâ”‚  â”‚ RetryManager â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Server Types: STDIO | SSE | Streamable HTTP                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ Built-in: filesystem, git, browser, calculator                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ External: Any MCP-compatible server                                      â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                              â”‚
â”‚                                         â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        âš™ï¸ INFRASTRUCTURE LAYER                                   â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚  Logfire    â”‚  â”‚   DBOS      â”‚  â”‚ Circuit     â”‚  â”‚ Connection  â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  Tracing    â”‚  â”‚  Durability â”‚  â”‚ Breaker     â”‚  â”‚   Pooling   â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚                                                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚ Response    â”‚  â”‚ Rate Limit  â”‚  â”‚ Context     â”‚  â”‚ Cost Budget â”‚            â”‚   â”‚
â”‚  â”‚  â”‚ Cache       â”‚  â”‚ Failover    â”‚  â”‚ Compressor  â”‚  â”‚ Manager     â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Core Components

### Component Registry

| Component | Location | Purpose |
|-----------|----------|---------|
| **EpistemicOrchestrator** | `core/epistemic_orchestrator.py` | Plan â†’ Execute â†’ Verify loop |
| **HuskyExecutionLayer** | `core/husky_execution.py` | Cerebras GLM 4.7 execution |
| **ModelRouter** | `core/model_router.py` | Tier-based task routing |
| **TokenBudgetManager** | `core/token_budget.py` | Rate limiting & cost tracking |
| **ContextCompressor** | `core/context_compressor.py` | Smart context reduction |
| **CircuitBreaker** | `core/circuit_breaker.py` | Fault tolerance |
| **ConnectionPool** | `core/connection_pool.py` | HTTP/2 connection reuse |
| **MCPManager** | `mcp_/manager.py` | MCP server orchestration |
| **MessageBus** | `messaging/bus.py` | Agent â†” UI communication |
| **BaseAgent** | `agents/base_agent.py` | Agent foundation class |

---

## Model Tier Hierarchy

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           MODEL TIER PYRAMID            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â–²
                             /â”‚\
                            / â”‚ \
                           /  â”‚  \    Tier 1: ARCHITECT
                          / Opus  \   Claude Opus 4.5, Kimi K2.5, Qwen3-235B
                         / K2.5    \  â€¢ Security audits
                        / Qwen3     \ â€¢ Conflict resolution, Planning
                       /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ â€¢ Final QA reviews
                      /       â”‚       \
                     /        â”‚        \   Tier 2: BUILDER-HIGH
                    /  GPT-5.2-Codex   \   â€¢ Complex refactoring
                   / DeepSeek R1-0528   \  â€¢ Algorithm design
                  / Kimi K2-Thinkingâ”€â”€â”€â”€\  â€¢ Agentic coding
                 /          â”‚            \
                /           â”‚             \  Tier 3: BUILDER-MID
               /   Sonnet 4.5, MiniMax    \  â€¢ Class design
              /   Gemini 3 Pro (1M ctx)    \ â€¢ API design
             /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\
            /             â”‚                 \
           /              â”‚                  \ Tier 4: LIBRARIAN
          /  Haiku, Gemini 3 Flash, OpenRouter\ â€¢ Context search
         /       (1M context, cost-effective)  \ â€¢ Documentation
        /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\
       /                  â”‚                      \
      /                   â”‚                       \ Tier 5: SPRINTER
     /          Cerebras GLM 4.7                   \ â€¢ Code generation
    /    1500+ tok/s | 358B MoE | 200K context      \ â€¢ Unit tests
   /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ â€¢ Boilerplate
  â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”â–”
```

### Routing Logic

```python
TaskComplexity.LOW       â†’ Tier 5 (Cerebras GLM 4.7)
TaskComplexity.MEDIUM    â†’ Tier 4 (Gemini Flash) or Tier 3 (Sonnet/MiniMax)
TaskComplexity.HIGH      â†’ Tier 2 (GPT-5.2-Codex/DeepSeek R1) or Tier 1 (Opus)
TaskComplexity.CRITICAL  â†’ Tier 1 (Opus/Kimi K2.5/Qwen3) always
```

---

## Production Readiness & Resilience

**Status**: âœ… Certified for Production (February 2026)  
**Uptime**: 99.9% expected | **Failure Rate**: <0.1% | **Tests**: 102/110 passing (92.7%)

### Recent Enhancements

1. **Generator Athrow() Fix** (`failover_model.py`)
   - Added `yielded` flag to track generator state
   - Prevents "generator didn't stop after athrow()" errors
   - Ensures clean generator teardown on exceptions

2. **5-Minute Model Cooldown** (`rate_limit_failover.py`)
   - Failed models enter 5-minute cooldown period
   - Prevents immediate retry of problematic models
   - Tracked in `_failed_models` dict with timestamps

3. **Enhanced Error Context** (`agent_tools.py`)
   - Detects specific error types: `UnexpectedModelBehavior`, `ToolRetryError`, rate limits
   - Detailed logging with error type and context
   - Improved debugging for validation failures

4. **Working Directory Validation** (`command_runner.py`)
   - Validates directory existence before command execution
   - Prevents execution in non-existent paths
   - Clear error messages with path information

### Failover Infrastructure

- **29+ Models**: Spanning 5 tiers with complete failover chains
- **Automatic Recovery**: Transparent failover on any model failure
- **Model Diversity**: Multiple providers (OpenAI, Anthropic, Google, Cerebras, etc.)
- **Cooldown Management**: 5-minute backoff prevents rapid retry
- **State Tracking**: Generator state prevents double-exit scenarios

### Test Coverage

```
Unit Tests:          92 passing   (API, core, tools)
Integration Tests:   18 passing   (E2E simulation)
Critical Path:       10/10 passing (Failover exhaustion, cooldown)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Total: 102/110 passing (92.7%) | Production Ready âœ…
```

**Full Certification**: See [WIGGUM-LOOP-CERTIFICATION.md](../WIGGUM-LOOP-CERTIFICATION.md)

---

## BART Orchestration System

### The Reasoning & Tasking Architecture

The EpistemicOrchestrator implements the BART Plan â†’ Execute â†’ Verify loop:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BART ORCHESTRATION SYSTEM                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. REASONING LAYER (Claude Opus 4.5 / Kimi K2.5 / Qwen3-235B)               â”‚     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ conduct_planning_interview()                               â”‚     â”‚
â”‚     â”‚   â€¢ Extract goals, assumptions, constraints                â”‚     â”‚
â”‚     â”‚   â€¢ Identify gaps and hypotheses                           â”‚     â”‚
â”‚     â”‚   â€¢ Decompose into Epics â†’ Phases â†’ Milestones             â”‚     â”‚
â”‚     â”‚   â€¢ Create EpistemicStateArtifact                          â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚  2. EXECUTE (Cerebras GLM 4.7 / GPT-5.2-Codex / MiniMax M2.1)               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ ContextCurator.slice_for_milestone()                       â”‚     â”‚
â”‚     â”‚   â€¢ Create MinimumViableContext (MVC)                      â”‚     â”‚
â”‚     â”‚   â€¢ Respect 50K token limit for Cerebras                   â”‚     â”‚
â”‚     â”‚   â€¢ Include only relevant files + specs                    â”‚     â”‚
â”‚     â”‚                                                            â”‚     â”‚
â”‚     â”‚ HuskyExecutionLayer.execute()                              â”‚     â”‚
â”‚     â”‚   â€¢ Apply GLMPromptOptimizer (Rules #1-4)                  â”‚     â”‚
â”‚     â”‚   â€¢ TaskDecomposer breaks complex tasks (Rule #5)          â”‚     â”‚
â”‚     â”‚   â€¢ Call Cerebras API with optimized params                â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚  3. BIDIRECTIONAL VERIFICATION (Ralph Loop)                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ RalphLoopVerifier.verify_code_generation()                 â”‚     â”‚
â”‚     â”‚   Phase 1: Static Analysis (Cost: $0)                      â”‚     â”‚
â”‚     â”‚            - AST parsing, syntax check                     â”‚     â”‚
â”‚     â”‚   Phase 2: Intent Verification (Claude Sonnet)             â”‚     â”‚
â”‚     â”‚            - Compare output to spec                        â”‚     â”‚
â”‚     â”‚            - Calculate drift score                         â”‚     â”‚
â”‚     â”‚   Phase 3: Spec Compliance Check                           â”‚     â”‚
â”‚     â”‚            - Verify each requirement met                   â”‚     â”‚
â”‚     â”‚   Phase 4: Checkpoint Verification                         â”‚     â”‚
â”‚     â”‚            - Run milestone-specific checks                 â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚     â”‚  PASS?  â”€â”€Yesâ”€â”€â–º Commit & Next Milestoneâ”‚                        â”‚
â”‚     â”‚    â”‚                                    â”‚                        â”‚
â”‚     â”‚   No                                    â”‚                        â”‚
â”‚     â”‚    â”‚                                    â”‚                        â”‚
â”‚     â”‚    â–¼                                    â”‚                        â”‚
â”‚     â”‚  Max Retries? â”€â”€Yesâ”€â”€â–º Mark FAILED     â”‚                        â”‚
â”‚     â”‚    â”‚                                    â”‚                        â”‚
â”‚     â”‚   No                                    â”‚                        â”‚
â”‚     â”‚    â”‚                                    â”‚                        â”‚
â”‚     â”‚    â–¼                                    â”‚                        â”‚
â”‚     â”‚  Generate feedback â†’ LOOP BACK TO EXECUTE                       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pydantic Models

```python
EpistemicStateArtifact
â”œâ”€â”€ goals: List[Goal]           # What we're trying to achieve
â”œâ”€â”€ hypotheses: List[Hypothesis] # Testable predictions
â”œâ”€â”€ assumptions: List[Assumption] # Things we assume true
â”œâ”€â”€ constraints: List[Constraint] # Hard/soft limits
â”œâ”€â”€ gaps: List[Gap]             # Knowledge gaps (CRITICAL, HIGH, MEDIUM, LOW)
â”œâ”€â”€ epics: List[Epic]           # High-level work units
â”‚   â””â”€â”€ phases: List[Phase]     # Sequential execution phases
â”‚       â””â”€â”€ milestones: List[Milestone]  # Atomic work items
â”‚           â””â”€â”€ checkpoints: List[Checkpoint]  # Verification points
â””â”€â”€ evidence: List[Evidence]    # Supporting data
```

---

## Cerebras GLM 4.7 Optimization

### The 10 Rules Implementation

| Rule | Description | Implementation |
|------|-------------|----------------|
| **#1** | Front-load instructions | `GLMPromptOptimizer.FRONT_LOADED_DIRECTIVES` |
| **#2** | Use MUST/STRICTLY language | `GLMPromptOptimizer.optimize_user_message()` |
| **#3** | Specify default language | `LANGUAGE_DIRECTIVE = "All responses MUST be in English"` |
| **#4** | Leverage role-play personas | `GLMPromptOptimizer.persona` with structured prompts |
| **#5** | Break up tasks | `TaskDecomposer.decompose()` with templates |
| **#6** | Disable reasoning when not needed | `disable_reasoning: True` in `extra_body` |
| **#7** | Enable reasoning for complex tasks | `disable_reasoning: False` (default) |
| **#8** | Use critic agents | `RalphLoopVerifier` + Shepherd/Watchdog agents |
| **#9** | Pair with frontier models | Opus plans â†’ GLM executes architecture |
| **#10** | Use clear_thinking | `clear_thinking: true/false` in `extra_body` |

### API Parameters

```python
# model_factory.py - GLM 4.7 settings
CerebrasGLMSettings:
    model_id: "zai-glm-4.7"
    temperature: 1.0           # Recommended default
    top_p: 0.95                # Recommended default
    max_context: 131_000       # 131K input tokens
    max_output: 40_000         # 40K output tokens
    disable_reasoning: bool    # Rule #6/#7
    clear_thinking: bool       # Rule #10
    
# Passed via extra_body for OpenAI-compatible SDK
extra_body = {
    "disable_reasoning": disable_reasoning,
    "clear_thinking": clear_thinking,
    "thinking": {
        "type": "enabled" | "disabled",
        "clear_thinking": True | False
    }
}
```

---

## Agent System

### Agent Hierarchy

```
                    BaseAgent (ABC)
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚                               â”‚
    CodePuppy       PackLeader                    Specialized
    (Main Agent)    (Orchestrator)                  Agents
         â”‚               â”‚                               â”‚
         â”‚               â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚                 â”‚             â”‚             â”‚
         â”‚          Pack Dogs          Reviewers     Creators      System
         â”‚         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”         â”Œâ”€â”€â”´â”€â”€â”       â”Œâ”€â”€â”´â”€â”€â”       â”Œâ”€â”€â”´â”€â”€â”
         â”‚         â”‚         â”‚         â”‚     â”‚       â”‚     â”‚       â”‚     â”‚
         â”‚    Bloodhound  Terrier   Python  TS   Planning QA  Epistemic Helios
         â”‚    Husky      Shepherd   C/C++ Go   Creator Expert Architect
         â”‚    Watchdog   Retriever  JS   ...                          
```

### Agent Tools

Each agent has access to specific tools based on their role:

```python
# Core Tools (all agents)
"read_file", "list_files", "grep", "agent_share_your_reasoning"

# Code Puppy (main agent)
"write_file", "edit_file", "agent_run_shell_command", 
"invoke_agent", "think"

# Pack Leader (orchestrator)
"agent_run_shell_command", "list_agents", "invoke_agent"

# Reviewers
"read_file", "list_files", "grep", "think"
```

---

## MCP Infrastructure

### Server Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MCPManager                              â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Registry   â”‚    â”‚   Status    â”‚    â”‚  Lifecycle  â”‚     â”‚
â”‚  â”‚  (configs)  â”‚â”€â”€â”€â–ºâ”‚  Tracker    â”‚â”€â”€â”€â–ºâ”‚  Manager    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                               â”‚              â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              ManagedMCPServer                        â”‚    â”‚
â”‚  â”‚  â€¢ State: STOPPED â†’ STARTING â†’ RUNNING â†’ STOPPED   â”‚    â”‚
â”‚  â”‚  â€¢ Quarantine on repeated failures                 â”‚    â”‚
â”‚  â”‚  â€¢ Health checks & latency monitoring              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  Server Types:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  STDIO  â”‚  â”‚   SSE   â”‚  â”‚ Streamable HTTP â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Token Budget & Cost Management

### Rate Limiting Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TokenBudgetManager                          â”‚
â”‚                                                             â”‚
â”‚  Provider Budgets:                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Cerebras:  300,000 tok/min â”‚ 24,000,000 tok/day    â”‚   â”‚
â”‚  â”‚ Gemini:    ~100,000 tok/min â”‚ ~2,000,000 tok/day   â”‚   â”‚
â”‚  â”‚ Anthropic: ~100,000 tok/min â”‚ ~1,000,000 tok/day   â”‚   â”‚
â”‚  â”‚ OpenAI:    ~100,000 tok/min â”‚ ~1,000,000 tok/day   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Budget Check Flow:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚ Estimate Tokens â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚           â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Yes    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Under Limit?   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Proceed with requestâ”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â”‚ No                                               â”‚
â”‚           â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚ Failover to    â”‚                                         â”‚
â”‚  â”‚ alternate modelâ”‚                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cost Tracking

```python
# Integration with genai-prices
Usage:
    model: str
    input_tokens: int
    output_tokens: int
    
calc_price(usage) â†’ Decimal (USD)

# Tracked per session
total_cost_usd: Decimal
cost_this_minute: Decimal
cost_today: Decimal
```

---

## Messaging & Event System

### Bidirectional Communication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MessageBus                             â”‚
â”‚                                                             â”‚
â”‚  Agent â†’ UI (Outgoing):                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ TextMessage â”‚ ConfirmationRequest â”‚ SelectionRequest â”‚   â”‚
â”‚  â”‚ ToolResult  â”‚ UserInputRequest    â”‚ ProgressUpdate   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  UI â†’ Agent (Incoming):                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ UserInputResponse â”‚ ConfirmationResponse â”‚ Cancel   â”‚   â”‚
â”‚  â”‚ SelectionResponse â”‚ Abort               â”‚           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Request/Response Correlation:                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ prompt_id â†’ asyncio.Future                          â”‚   â”‚
â”‚  â”‚ â€¢ request_input() waits on Future                   â”‚   â”‚
â”‚  â”‚ â€¢ provide_response() resolves Future                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Plugin Architecture

### Hook System

```python
# code_puppy/callbacks.py
HOOKS = [
    "on_agent_run_start",
    "on_agent_run_end", 
    "on_tool_call",
    "on_tool_result",
    "on_register_model_providers",
    "on_register_tools",
    "on_register_commands",
]

# Plugin registration
# code_puppy/plugins/<plugin_name>/__init__.py
def on_agent_run_start(agent, context):
    """Called before agent execution."""
    
def on_tool_call(tool_name, args):
    """Called before tool execution."""
```

### Available Plugins

| Plugin | Purpose |
|--------|---------|
| `agent_skills` | Dynamic skill loading, SKILL.md discovery, TUI management |
| `antigravity_oauth` | OAuth for Antigravity |
| `chatgpt_oauth` | OAuth for ChatGPT |
| `claude_code_oauth` | OAuth for Claude Code |
| `customizable_commands` | User-defined slash commands |
| `file_permission_handler` | File access control |
| `frontend_emitter` | Frontend event emission |
| `ralph` | Epistemic Agent Runtime |
| `shell_safety` | Shell command safety |
| `universal_constructor` | UC pattern implementation |

---

## Scheduler System

The Scheduler enables automated task execution on configurable schedules:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SCHEDULER SYSTEM                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Components:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ScheduledTask    - Task definition with schedule     â”‚   â”‚
â”‚  â”‚ SchedulerDaemon  - Background process runner         â”‚   â”‚
â”‚  â”‚ TaskExecutor     - Invokes code-puppy CLI            â”‚   â”‚
â”‚  â”‚ SchedulerAgent   - AI assistant for task management  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Schedule Types:                                            â”‚
â”‚  â€¢ interval  - Run every X time (30m, 2h, 1d)             â”‚
â”‚  â€¢ hourly    - Run once per hour                          â”‚
â”‚  â€¢ daily     - Run once per day                           â”‚
â”‚  â€¢ cron      - Cron expression (planned)                  â”‚
â”‚                                                             â”‚
â”‚  Commands:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ /scheduler        - Launch TUI menu                  â”‚   â”‚
â”‚  â”‚ /scheduler start  - Start daemon                     â”‚   â”‚
â”‚  â”‚ /scheduler stop   - Stop daemon                      â”‚   â”‚
â”‚  â”‚ /scheduler list   - List all tasks                   â”‚   â”‚
â”‚  â”‚ /scheduler run <id> - Run task immediately           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Agent Skills System

Agent Skills are reusable, modular capabilities loaded dynamically:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AGENT SKILLS SYSTEM                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Skill Structure:                                           â”‚
â”‚  ~/.code_puppy/skills/                                      â”‚
â”‚  â”œâ”€â”€ docker/                                                â”‚
â”‚  â”‚   â””â”€â”€ SKILL.md  (YAML frontmatter + instructions)       â”‚
â”‚  â”œâ”€â”€ kubernetes/                                            â”‚
â”‚  â”‚   â””â”€â”€ SKILL.md                                          â”‚
â”‚  â””â”€â”€ security-audit/                                        â”‚
â”‚      â””â”€â”€ SKILL.md                                          â”‚
â”‚                                                             â”‚
â”‚  Tools:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ list_or_search_skills(query)                         â”‚   â”‚
â”‚  â”‚   - List/search available skills                     â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚ activate_skill(skill_name)                           â”‚   â”‚
â”‚  â”‚   - Load full SKILL.md content for use              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Commands:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ /skills        - Launch TUI menu                     â”‚   â”‚
â”‚  â”‚ /skills list   - List all skills                     â”‚   â”‚
â”‚  â”‚ /skills enable - Enable skills globally              â”‚   â”‚
â”‚  â”‚ /skills disable - Disable skills globally            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Interactive Tools

### ask_user_question Tool

A TUI-based tool for gathering user input through interactive multiple-choice questions:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ask_user_question                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Features:                                                  â”‚
â”‚  â€¢ Split-panel TUI with question headers on left           â”‚
â”‚  â€¢ Options with descriptions on right                      â”‚
â”‚  â€¢ Single-select and multi-select modes                    â”‚
â”‚  â€¢ "Other" option for custom input                         â”‚
â”‚  â€¢ Timeout with warning countdown                          â”‚
â”‚  â€¢ Vim-style navigation (j/k) + arrow keys                 â”‚
â”‚                                                             â”‚
â”‚  Controls:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â†‘â†“ / j/k  - Navigate options                         â”‚   â”‚
â”‚  â”‚ â†â†’ / h/l  - Switch between questions                 â”‚   â”‚
â”‚  â”‚ Space     - Toggle/select option                     â”‚   â”‚
â”‚  â”‚ Enter     - Next question / submit                   â”‚   â”‚
â”‚  â”‚ Ctrl+S    - Submit all answers                       â”‚   â”‚
â”‚  â”‚ Esc       - Cancel interaction                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Safety:                                                    â”‚
â”‚  â€¢ Disabled in sub-agent contexts (prevent infinite loops)â”‚
â”‚  â€¢ Disabled during /wiggum autonomous mode                â”‚
â”‚  â€¢ Requires interactive terminal (stdin TTY)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagrams

### User Request â†’ Response

```
User Input
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLI / API / WS  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MessageBus    â”‚â”€â”€â”€â”€â–ºâ”‚ Command Handler â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent Manager  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EpistemicOrch.  â”‚ â—„â”€â”€â”€ Plan with Opus
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Model Router   â”‚ â—„â”€â”€â”€ Route to optimal tier
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TokenBudgetMgr  â”‚ â—„â”€â”€â”€ Check rate limits
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Provider (API)  â”‚ â—„â”€â”€â”€ Cerebras / Anthropic / etc.
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RalphLoopVerify â”‚ â—„â”€â”€â”€ Verify output
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
Response to User
```

---

## File Structure Summary

```
code_puppy/
â”œâ”€â”€ __main__.py              # Entry point
â”œâ”€â”€ main.py                  # Main application
â”œâ”€â”€ cli_runner.py            # CLI interface
â”œâ”€â”€ config.py                # Configuration management
â”œâ”€â”€ model_factory.py         # Model instantiation
â”œâ”€â”€ session_storage.py       # Session persistence
â”‚
â”œâ”€â”€ core/                    # Core infrastructure
â”‚   â”œâ”€â”€ epistemic_orchestrator.py  # ğŸ§  Plan â†’ Execute â†’ Verify
â”‚   â”œâ”€â”€ husky_execution.py        # ğŸ¦® Cerebras GLM execution
â”‚   â”œâ”€â”€ model_router.py           # ğŸ”€ Tier-based routing
â”‚   â”œâ”€â”€ token_budget.py           # ğŸ’° Rate limiting
â”‚   â”œâ”€â”€ context_compressor.py     # ğŸ“¦ Context reduction
â”‚   â”œâ”€â”€ circuit_breaker.py        # âš¡ Fault tolerance
â”‚   â”œâ”€â”€ connection_pool.py        # ğŸ”Œ HTTP pooling
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ agents/                  # Agent definitions
â”‚   â”œâ”€â”€ base_agent.py            # Base class
â”‚   â”œâ”€â”€ agent_code_puppy.py      # Main agent
â”‚   â”œâ”€â”€ agent_pack_leader.py     # Orchestrator
â”‚   â”œâ”€â”€ pack/                    # Pack dogs
â”‚   â”‚   â”œâ”€â”€ bloodhound.py
â”‚   â”‚   â”œâ”€â”€ husky.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ tools/                   # Tool implementations
â”‚   â”œâ”€â”€ agent_tools.py
â”‚   â”œâ”€â”€ file_operations.py
â”‚   â”œâ”€â”€ command_runner.py
â”‚   â”œâ”€â”€ token_slimmer.py
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ mcp_/                    # MCP infrastructure
â”‚   â”œâ”€â”€ manager.py
â”‚   â”œâ”€â”€ managed_server.py
â”‚   â”œâ”€â”€ registry.py
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ messaging/               # Event system
â”‚   â”œâ”€â”€ bus.py
â”‚   â”œâ”€â”€ messages.py
â”‚   â”œâ”€â”€ renderers.py
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ plugins/                 # Plugin system
â”‚   â”œâ”€â”€ ralph/              # Epistemic runtime
â”‚   â”œâ”€â”€ shell_safety/
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ epistemic/              # Epistemic Agent Runtime
    â””â”€â”€ ear-runtime/
        â””â”€â”€ src/ear/
            â””â”€â”€ core/
                â”œâ”€â”€ ralph_loop.py
                â””â”€â”€ state.py
```

---

## Observability

### Logfire Integration

All major components are instrumented with Logfire spans:

```python
# Spans created by EpistemicOrchestrator
"Ralph Loop"              # Full loop with iteration count
"Ralph Iteration"         # Single iteration
"Execute Code Generation" # Code gen within iteration
"Execute Milestone"       # Milestone execution
"Slice Context"           # Context slicing
"Verify Code Generation"  # Full verification
"Static Analysis"         # Phase 1
"Intent Verification"     # Phase 2
"Spec Compliance Check"   # Phase 3
"Checkpoint Verification" # Phase 4

# Spans created by HuskyExecutionLayer
"Husky Execute"          # Full execution
"Build Prompt"           # Prompt construction
```

### Metrics Tracked

- Token usage (input/output per provider)
- Cost per request (genai-prices)
- Latency (per model, per provider)
- Error rates (429s, timeouts, failures)
- Drift scores (verification)
- Retry counts (Ralph Loop)

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 2.0 | 2026-01-31 | BART System (Belief-Augmented Reasoning & Tasking), GLM 4.7 optimization |
| 1.1 | 2026-01-25 | Token budget manager, circuit breaker |
| 1.0 | 2025-12-01 | Initial release |

---

*Generated for Code Puppy v2.0 - BART System (Belief-Augmented Reasoning & Tasking)*
