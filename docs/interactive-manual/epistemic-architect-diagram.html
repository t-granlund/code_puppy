<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epistemic Architect - Interactive Architecture Diagram</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0d1117 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .nav-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(30, 30, 60, 0.8);
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .nav-bar a { color: #888; text-decoration: none; font-size: 0.9rem; transition: color 0.2s; }
        .nav-bar a:hover { color: #7c3aed; }
        .nav-bar a.active { color: #10b981; font-weight: 600; }
        .nav-title { font-size: 1.3rem; font-weight: 700; color: #10b981; display: flex; align-items: center; gap: 10px; }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7c3aed, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        /* Control Panel */
        .control-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
        }

        .control-btn.secondary {
            background: #2a2a4a;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }

        .control-btn.active {
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.6);
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Panel Styles */
        .panel {
            background: rgba(30, 30, 60, 0.8);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Pipeline Stages (Left Panel) */
        .pipeline-stages {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stage {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            background: rgba(40, 40, 70, 0.6);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .stage:hover {
            background: rgba(60, 60, 100, 0.8);
            transform: translateX(5px);
        }

        .stage.active {
            background: rgba(124, 58, 237, 0.3);
            border-left-color: #7c3aed;
        }

        .stage.completed {
            border-left-color: #10b981;
        }

        .stage-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(100, 100, 150, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .stage.active .stage-number {
            background: #7c3aed;
            animation: pulse 2s infinite;
        }

        .stage.completed .stage-number {
            background: #10b981;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(124, 58, 237, 0); }
        }

        .stage-info {
            flex: 1;
        }

        .stage-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .stage-desc {
            font-size: 0.75rem;
            color: #888;
            margin-top: 2px;
        }

        /* Center Visualization */
        .center-viz {
            min-height: 600px;
            position: relative;
        }

        /* OODA Loop Visualization */
        .ooda-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }

        .ooda-loop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            height: 320px;
        }

        .ooda-phase {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 3px solid transparent;
        }

        .ooda-phase:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .ooda-phase.active {
            animation: glow 1.5s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); }
            50% { box-shadow: 0 0 40px rgba(0, 212, 255, 0.8); }
        }

        .ooda-phase.observe {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .ooda-phase.orient {
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .ooda-phase.decide {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .ooda-phase.act {
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .ooda-emoji {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .ooda-label {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .ooda-agents {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
            text-align: center;
        }

        /* Arrow SVG */
        .ooda-arrows {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .arrow-path {
            fill: none;
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 3;
            stroke-dasharray: 10, 5;
        }

        .arrow-path.animated {
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to { stroke-dashoffset: -15; }
        }

        /* Lenses Grid */
        .lenses-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .lens-card {
            background: rgba(40, 40, 70, 0.6);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .lens-card:hover {
            background: rgba(60, 60, 100, 0.8);
            transform: translateY(-5px);
            border-color: rgba(124, 58, 237, 0.5);
        }

        .lens-card.active {
            border-color: #7c3aed;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.4);
        }

        .lens-emoji {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .lens-name {
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Quality Gates */
        .gates-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .gate-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(40, 40, 70, 0.6);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gate-badge:hover {
            background: rgba(60, 60, 100, 0.8);
        }

        .gate-badge.passed {
            background: rgba(16, 185, 129, 0.3);
            border: 1px solid #10b981;
        }

        .gate-badge.failed {
            background: rgba(239, 68, 68, 0.3);
            border: 1px solid #ef4444;
        }

        /* Right Panel - Info & Telemetry */
        .info-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-section {
            background: rgba(40, 40, 70, 0.5);
            border-radius: 12px;
            padding: 15px;
        }

        .info-title {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #00d4ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-content {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #ccc;
        }

        /* Telemetry Events */
        .telemetry-stream {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.75rem;
        }

        .telemetry-event {
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 6px;
            background: rgba(30, 30, 50, 0.8);
            border-left: 3px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .telemetry-event.info { border-left-color: #3b82f6; }
        .telemetry-event.warn { border-left-color: #f59e0b; }
        .telemetry-event.success { border-left-color: #10b981; }

        .telemetry-time {
            color: #666;
            font-size: 0.7rem;
        }

        /* Agent Cards */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .agent-card {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(50, 50, 80, 0.5);
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .agent-card:hover {
            background: rgba(70, 70, 110, 0.6);
        }

        .agent-workload {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .agent-workload.coding { background: #ef4444; }
        .agent-workload.reasoning { background: #3b82f6; }
        .agent-workload.orchestrator { background: #7c3aed; }
        .agent-workload.librarian { background: #10b981; }

        /* Flow Visualization */
        .flow-container {
            margin-top: 20px;
            padding: 20px;
            background: rgba(20, 20, 40, 0.5);
            border-radius: 12px;
        }

        .flow-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #ff6b6b;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .flow-node {
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            min-width: 100px;
        }

        .flow-arrow {
            font-size: 1.5rem;
            color: #666;
        }

        .flow-node.user { background: linear-gradient(135deg, #ec4899, #be185d); }
        .flow-node.phase1 { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .flow-node.phase2 { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .flow-node.output { background: linear-gradient(135deg, #10b981, #059669); }

        /* Modification Prompt Area */
        .prompt-area {
            margin-top: 20px;
        }

        .prompt-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(124, 58, 237, 0.5);
            border-radius: 12px;
            background: rgba(30, 30, 60, 0.8);
            color: #e0e0e0;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
        }

        .prompt-input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
        }

        .prompt-examples {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #888;
        }

        .prompt-example {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px 5px 0 0;
            background: rgba(60, 60, 100, 0.5);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .prompt-example:hover {
            background: rgba(124, 58, 237, 0.5);
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            padding: 15px;
            background: rgba(20, 20, 40, 0.95);
            border: 1px solid rgba(124, 58, 237, 0.5);
            border-radius: 10px;
            max-width: 300px;
            font-size: 0.85rem;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: #00d4ff;
        }

        /* Animation Container */
        .animation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .flow-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00d4ff;
            box-shadow: 0 0 10px #00d4ff;
            animation: particleFlow 3s linear infinite;
        }

        @keyframes particleFlow {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 30, 60, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(124, 58, 237, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(124, 58, 237, 0.7);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <div class="nav-title">üèõÔ∏è Epistemic Architect</div>
            <a href="epistemic-architect-diagram.html" class="active">Architecture</a>
            <a href="telemetry.html">Telemetry</a>
            <a href="ooda-failover.html">OODA & Failover</a>
            <a href="phases.html">Phases</a>
            <a href="rules.html">Rules</a>
            <a href="agents.html">Agents</a>
        </div>

        <h1>üèõÔ∏è Epistemic Architect üî¨</h1>
        <p class="subtitle">BART System ‚Ä¢ Ralph Loops ‚Ä¢ Evidence-Based Reasoning</p>

        <!-- Control Panel -->
        <div class="control-panel">
            <button class="control-btn primary" id="btn-simulate" onclick="startSimulation()">
                ‚ñ∂Ô∏è Simulate Full Flow
            </button>
            <button class="control-btn secondary" onclick="togglePhase(1)">
                üìã Phase 1: Interview
            </button>
            <button class="control-btn secondary" onclick="togglePhase(2)">
                ü§ñ Phase 2: Wiggum
            </button>
            <button class="control-btn secondary" onclick="showTelemetry()">
                üî• Logfire Events
            </button>
            <button class="control-btn secondary" onclick="resetView()">
                üîÑ Reset
            </button>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Panel: Pipeline Stages -->
            <div class="panel">
                <div class="panel-title">üìã 14-Stage Pipeline</div>
                <div class="pipeline-stages" id="pipeline-stages">
                    <!-- Stages injected via JS -->
                </div>
            </div>

            <!-- Center: Main Visualization -->
            <div class="panel center-viz">
                <!-- OODA Loop -->
                <div class="panel-title">üîÑ Ralph (OODA) Loop</div>
                <div class="ooda-container">
                    <svg class="ooda-arrows" viewBox="0 0 320 320">
                        <!-- Curved arrows between phases -->
                        <path class="arrow-path animated" d="M 160 60 Q 240 60 240 160" />
                        <path class="arrow-path animated" d="M 240 160 Q 240 260 160 260" />
                        <path class="arrow-path animated" d="M 160 260 Q 80 260 80 160" />
                        <path class="arrow-path animated" d="M 80 160 Q 80 60 160 60" />
                    </svg>
                    <div class="ooda-loop">
                        <div class="ooda-phase observe" onclick="selectOODA('observe')" data-tooltip="OBSERVE: Gather context using list_files, read_file, grep. Build understanding of current state.">
                            <div class="ooda-emoji">üëÅÔ∏è</div>
                            <div class="ooda-label">OBSERVE</div>
                            <div class="ooda-agents">Own tools</div>
                        </div>
                        <div class="ooda-phase orient" onclick="selectOODA('orient')" data-tooltip="ORIENT: Delegate to REASONING agents. Security Auditor, Code Reviewer, QA Expert analyze in parallel.">
                            <div class="ooda-emoji">üß≠</div>
                            <div class="ooda-label">ORIENT</div>
                            <div class="ooda-agents">REASONING</div>
                        </div>
                        <div class="ooda-phase decide" onclick="selectOODA('decide')" data-tooltip="DECIDE: Synthesize analyses and make strategic decisions. Update BUILD.md with next actions.">
                            <div class="ooda-emoji">üéØ</div>
                            <div class="ooda-label">DECIDE</div>
                            <div class="ooda-agents">ORCHESTRATOR</div>
                        </div>
                        <div class="ooda-phase act" onclick="selectOODA('act')" data-tooltip="ACT: Delegate to CODING agents. Python Programmer, Test Generator, Doc Writer execute in parallel.">
                            <div class="ooda-emoji">‚ö°</div>
                            <div class="ooda-label">ACT</div>
                            <div class="ooda-agents">CODING</div>
                        </div>
                    </div>
                </div>

                <!-- 7 Expert Lenses -->
                <div class="panel-title">üîç 7 Expert Lenses</div>
                <div class="lenses-grid" id="lenses-grid">
                    <!-- Lenses injected via JS -->
                </div>

                <!-- 6 Quality Gates -->
                <div class="panel-title" style="margin-top: 20px;">‚úÖ 6 Quality Gates</div>
                <div class="gates-container" id="gates-container">
                    <!-- Gates injected via JS -->
                </div>

                <!-- Flow Diagram -->
                <div class="flow-container">
                    <div class="flow-title">üìä End-to-End Workflow</div>
                    <div class="flow-diagram">
                        <div class="flow-node user">üë§ User<br>Prompt</div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node phase1">üìã Phase 1<br>Interview<br>(Stages 0-6)</div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node phase1">üîê Stage 7<br>Auth<br>Pre-Flight</div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node phase2">ü§ñ Phase 2<br>Wiggum<br>(Stages 8-13)</div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node output">‚úÖ Working<br>Product</div>
                    </div>
                </div>

                <!-- Prompt Modification Area -->
                <div class="prompt-area">
                    <div class="panel-title">üí¨ Modify via Prompting</div>
                    <textarea class="prompt-input" placeholder="Enter prompts to modify the Epistemic Architect behavior...

Examples:
‚Ä¢ 'Add a new lens for regulatory compliance'
‚Ä¢ 'Skip the authentication pre-flight for local development'
‚Ä¢ 'Use aggressive parallelization in ACT phase'"></textarea>
                    <div class="prompt-examples">
                        Quick modifications:
                        <span class="prompt-example" onclick="applyPrompt('skip_lens')">Skip Topology Lens</span>
                        <span class="prompt-example" onclick="applyPrompt('add_gate')">Add Custom Gate</span>
                        <span class="prompt-example" onclick="applyPrompt('fast_mode')">Fast Mode (fewer checkpoints)</span>
                        <span class="prompt-example" onclick="applyPrompt('strict_mode')">Strict Mode (all gates required)</span>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Info & Telemetry -->
            <div class="panel info-panel">
                <!-- Current State -->
                <div class="info-section">
                    <div class="info-title">üìä Current State</div>
                    <div class="info-content" id="current-state">
                        <strong>Stage:</strong> 0 - Project Discovery<br>
                        <strong>Phase:</strong> Interactive Interview<br>
                        <strong>OODA:</strong> OBSERVE<br>
                        <strong>Confidence:</strong> 0.70
                    </div>
                </div>

                <!-- Agent Directory -->
                <div class="info-section">
                    <div class="info-title">ü§ñ Available Agents</div>
                    <div class="agent-grid" id="agent-grid">
                        <!-- Agents injected via JS -->
                    </div>
                </div>

                <!-- Logfire Telemetry -->
                <div class="info-section">
                    <div class="info-title">üî• Logfire Telemetry</div>
                    <div class="telemetry-stream" id="telemetry-stream">
                        <!-- Telemetry events injected via JS -->
                    </div>
                </div>

                <!-- Tools -->
                <div class="info-section">
                    <div class="info-title">üîß Active Tools</div>
                    <div class="info-content" id="active-tools">
                        <code>list_files</code>, <code>read_file</code>, <code>grep</code>,
                        <code>edit_file</code>, <code>ask_user_question</code>,
                        <code>invoke_agent</code>, <code>preflight_auth_check</code>,
                        <code>discover_project</code>, <code>complete_wiggum_loop</code>
                    </div>
                </div>

                <!-- Artifacts -->
                <div class="info-section">
                    <div class="info-title">üìÅ Artifacts Generated</div>
                    <div class="info-content" id="artifacts">
                        <code>epistemic/state.json</code><br>
                        <code>epistemic/auth-checklist.json</code><br>
                        <code>BUILD.md</code><br>
                        <code>docs/lens-evaluation.md</code><br>
                        <code>docs/gap-analysis.md</code><br>
                        <code>specs/entities.md</code>
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #7c3aed;"></div>
                <span>ORCHESTRATOR (Kimi K2.5)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3b82f6;"></div>
                <span>REASONING (DeepSeek R1)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ef4444;"></div>
                <span>CODING (Cerebras GLM 4.7)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #10b981;"></div>
                <span>LIBRARIAN (Haiku/Flash)</span>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Animation Overlay -->
    <div class="animation-overlay" id="animation-overlay"></div>

    <script>
        // =====================================================================
        // DATA DEFINITIONS
        // =====================================================================

        const PIPELINE_STAGES = [
            { id: 0, name: "Project Discovery", desc: "Bootstrap & scan existing artifacts", phase: 1 },
            { id: 1, name: "Epistemic State", desc: "Interview user, surface assumptions", phase: 1 },
            { id: 2, name: "Lens Evaluation", desc: "Apply 7 expert perspectives", phase: 1 },
            { id: 3, name: "Gap Analysis", desc: "CRITICAL/HIGH/MEDIUM/LOW gaps", phase: 1 },
            { id: 4, name: "Goal Emergence", desc: "Generate & validate through gates", phase: 1 },
            { id: 5, name: "MVP Planning", desc: "Minimal viable plan + rollback", phase: 1 },
            { id: 6, name: "Spec Generation", desc: "Full specs, readiness check", phase: 1 },
            { id: 7, name: "Pre-Flight Auth", desc: "Verify all auth requirements", phase: "gate" },
            { id: 8, name: "Build Execution", desc: "Phase ‚Üí Milestone ‚Üí Verify", phase: 2 },
            { id: 9, name: "Improvement Audit", desc: "Evidence ‚Üí Analysis ‚Üí Rec", phase: 2 },
            { id: 10, name: "Gap Re-Inspection", desc: "What new gaps emerged?", phase: 2 },
            { id: 11, name: "Question Tracking", desc: "Update state, close hypotheses", phase: 2 },
            { id: 12, name: "Verification Audit", desc: "End-to-end check", phase: 2 },
            { id: 13, name: "Documentation Sync", desc: "Update docs ‚Üí loop to 9", phase: 2 }
        ];

        const EXPERT_LENSES = [
            { name: "Philosophy", emoji: "üß†", question: "What are we assuming?" },
            { name: "Data Science", emoji: "üìä", question: "Can we measure this?" },
            { name: "Safety/Risk", emoji: "üõ°Ô∏è", question: "What could go wrong?" },
            { name: "Topology", emoji: "üî∑", question: "What's the structure?" },
            { name: "Theoretical Math", emoji: "‚àë", question: "Is this consistent?" },
            { name: "Systems Eng", emoji: "‚öôÔ∏è", question: "Can we build this?" },
            { name: "Product/UX", emoji: "üë§", question: "Does this help users?" }
        ];

        const QUALITY_GATES = [
            { name: "Observables", emoji: "üëÅÔ∏è", check: "Measurable outcomes?" },
            { name: "Testability", emoji: "üß™", check: "Success/failure criteria?" },
            { name: "Reversibility", emoji: "‚Ü©Ô∏è", check: "Rollback plan?" },
            { name: "Confidence", emoji: "üìà", check: "‚â•0.6 confidence?" },
            { name: "Lens Agreement", emoji: "ü§ù", check: "3+ lenses approve?" },
            { name: "Evidence", emoji: "üìö", check: "Based on evidence?" }
        ];

        const AGENTS = [
            { name: "pack-leader", workload: "orchestrator" },
            { name: "helios", workload: "orchestrator" },
            { name: "security-auditor", workload: "reasoning" },
            { name: "code-reviewer", workload: "reasoning" },
            { name: "qa-expert", workload: "reasoning" },
            { name: "python-programmer", workload: "coding" },
            { name: "test-generator", workload: "coding" },
            { name: "doc-writer", workload: "librarian" },
            { name: "husky", workload: "coding" },
            { name: "shepherd", workload: "reasoning" }
        ];

        const TELEMETRY_EVENTS = [
            { type: "info", msg: "Workload routing: epistemic-architect ‚Üí ORCHESTRATOR ‚Üí kimi-k2.5" },
            { type: "info", msg: "Request start: epistemic-architect using kimi-k2.5" },
            { type: "success", msg: "EAR phase: OBSERVE ‚Üí state captured" },
            { type: "info", msg: "OODA Delegation: architect ‚Üí security-auditor (ORIENT)" },
            { type: "warn", msg: "Rate limit: cerebras-glm-4.7 - cooldown 30s" },
            { type: "info", msg: "Failover triggered: cerebras ‚Üí deepseek-r1" },
            { type: "success", msg: "Delegation complete: architect ‚Üê python-programmer" },
            { type: "info", msg: "Pre-flight auth: azure-cli verified" },
            { type: "success", msg: "Quality gate passed: Observables ‚úì" }
        ];

        // =====================================================================
        // STATE
        // =====================================================================

        let currentStage = 0;
        let currentPhase = 1;
        let currentOODA = 'observe';
        let simulationRunning = false;
        let telemetryIndex = 0;

        // =====================================================================
        // INITIALIZATION
        // =====================================================================

        function init() {
            renderPipelineStages();
            renderLenses();
            renderGates();
            renderAgents();
            setupTooltips();
            updateStateDisplay();
        }

        function renderPipelineStages() {
            const container = document.getElementById('pipeline-stages');
            container.innerHTML = PIPELINE_STAGES.map(stage => `
                <div class="stage ${stage.id === currentStage ? 'active' : ''}" 
                     data-stage="${stage.id}"
                     onclick="selectStage(${stage.id})">
                    <div class="stage-number">${stage.id}</div>
                    <div class="stage-info">
                        <div class="stage-name">${stage.name}</div>
                        <div class="stage-desc">${stage.desc}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderLenses() {
            const container = document.getElementById('lenses-grid');
            container.innerHTML = EXPERT_LENSES.map((lens, i) => `
                <div class="lens-card" onclick="selectLens(${i})" 
                     data-tooltip="${lens.question}">
                    <div class="lens-emoji">${lens.emoji}</div>
                    <div class="lens-name">${lens.name}</div>
                </div>
            `).join('');
        }

        function renderGates() {
            const container = document.getElementById('gates-container');
            container.innerHTML = QUALITY_GATES.map((gate, i) => `
                <div class="gate-badge" onclick="toggleGate(${i})"
                     data-tooltip="${gate.check}">
                    <span>${gate.emoji}</span>
                    <span>${gate.name}</span>
                </div>
            `).join('');
        }

        function renderAgents() {
            const container = document.getElementById('agent-grid');
            container.innerHTML = AGENTS.map(agent => `
                <div class="agent-card" onclick="selectAgent('${agent.name}')">
                    <span class="agent-workload ${agent.workload}">${agent.workload.charAt(0).toUpperCase()}</span>
                    <span>${agent.name}</span>
                </div>
            `).join('');
        }

        // =====================================================================
        // INTERACTIONS
        // =====================================================================

        function selectStage(id) {
            currentStage = id;
            const stage = PIPELINE_STAGES[id];
            currentPhase = stage.phase === 'gate' ? 1.5 : stage.phase;
            
            document.querySelectorAll('.stage').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-stage="${id}"]`).classList.add('active');
            
            updateStateDisplay();
            addTelemetryEvent('info', `Stage ${id}: ${stage.name}`);
        }

        function selectOODA(phase) {
            currentOODA = phase;
            document.querySelectorAll('.ooda-phase').forEach(el => el.classList.remove('active'));
            document.querySelector(`.ooda-phase.${phase}`).classList.add('active');
            
            updateStateDisplay();
            addTelemetryEvent('success', `EAR phase: ${phase.toUpperCase()}`);
        }

        function selectLens(index) {
            const lens = EXPERT_LENSES[index];
            document.querySelectorAll('.lens-card').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.lens-card')[index].classList.add('active');
            
            addTelemetryEvent('info', `Lens evaluation: ${lens.name} - ${lens.question}`);
        }

        function toggleGate(index) {
            const gate = QUALITY_GATES[index];
            const el = document.querySelectorAll('.gate-badge')[index];
            
            if (el.classList.contains('passed')) {
                el.classList.remove('passed');
                el.classList.add('failed');
                addTelemetryEvent('warn', `Gate FAILED: ${gate.name}`);
            } else if (el.classList.contains('failed')) {
                el.classList.remove('failed');
                addTelemetryEvent('info', `Gate reset: ${gate.name}`);
            } else {
                el.classList.add('passed');
                addTelemetryEvent('success', `Gate PASSED: ${gate.name} ‚úì`);
            }
        }

        function selectAgent(name) {
            const agent = AGENTS.find(a => a.name === name);
            addTelemetryEvent('info', `invoke_agent("${name}") ‚Üí ${agent.workload.toUpperCase()} workload`);
        }

        // =====================================================================
        // SIMULATION
        // =====================================================================

        async function startSimulation() {
            if (simulationRunning) return;
            simulationRunning = true;
            
            const btn = document.getElementById('btn-simulate');
            btn.textContent = '‚è∏Ô∏è Running...';
            btn.classList.add('active');

            // Reset state
            currentStage = 0;
            telemetryIndex = 0;
            document.getElementById('telemetry-stream').innerHTML = '';

            // Simulate through stages
            for (let i = 0; i < PIPELINE_STAGES.length && simulationRunning; i++) {
                selectStage(i);
                
                // Simulate OODA loop for each stage
                const oodaPhases = ['observe', 'orient', 'decide', 'act'];
                for (const phase of oodaPhases) {
                    if (!simulationRunning) break;
                    selectOODA(phase);
                    await sleep(800);
                }

                // Add telemetry events
                if (TELEMETRY_EVENTS[telemetryIndex]) {
                    const event = TELEMETRY_EVENTS[telemetryIndex];
                    addTelemetryEvent(event.type, event.msg);
                    telemetryIndex++;
                }

                await sleep(500);
            }

            btn.textContent = '‚ñ∂Ô∏è Simulate Full Flow';
            btn.classList.remove('active');
            simulationRunning = false;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // =====================================================================
        // PHASE TOGGLES
        // =====================================================================

        function togglePhase(phase) {
            currentPhase = phase;
            
            if (phase === 1) {
                // Jump to interview stages
                selectStage(1);
                addTelemetryEvent('info', 'Entering Phase 1: Interactive Interview');
            } else {
                // Jump to wiggum stages
                selectStage(8);
                addTelemetryEvent('info', 'Entering Phase 2: Wiggum Autonomous Mode');
            }
        }

        function showTelemetry() {
            // Add all telemetry events
            for (const event of TELEMETRY_EVENTS) {
                addTelemetryEvent(event.type, event.msg);
            }
        }

        function resetView() {
            currentStage = 0;
            currentPhase = 1;
            currentOODA = 'observe';
            simulationRunning = false;
            
            document.getElementById('telemetry-stream').innerHTML = '';
            document.querySelectorAll('.stage').forEach(el => el.classList.remove('active', 'completed'));
            document.querySelectorAll('.ooda-phase').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.lens-card').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.gate-badge').forEach(el => el.classList.remove('passed', 'failed'));
            
            renderPipelineStages();
            updateStateDisplay();
        }

        // =====================================================================
        // PROMPT MODIFICATIONS
        // =====================================================================

        function applyPrompt(type) {
            const prompts = {
                'skip_lens': 'Skipping Topology lens for this iteration',
                'add_gate': 'Added custom gate: Security Review',
                'fast_mode': 'Fast mode: Reduced checkpoints (MVP focus)',
                'strict_mode': 'Strict mode: All 6 gates required'
            };
            
            addTelemetryEvent('info', `Configuration: ${prompts[type]}`);
        }

        // =====================================================================
        // TELEMETRY
        // =====================================================================

        function addTelemetryEvent(type, msg) {
            const stream = document.getElementById('telemetry-stream');
            const time = new Date().toLocaleTimeString();
            
            const event = document.createElement('div');
            event.className = `telemetry-event ${type}`;
            event.innerHTML = `
                <div class="telemetry-time">${time}</div>
                <div>${msg}</div>
            `;
            
            stream.insertBefore(event, stream.firstChild);
            
            // Keep only last 20 events
            while (stream.children.length > 20) {
                stream.removeChild(stream.lastChild);
            }
        }

        // =====================================================================
        // STATE DISPLAY
        // =====================================================================

        function updateStateDisplay() {
            const stage = PIPELINE_STAGES[currentStage];
            const phaseText = currentPhase === 1 ? 'Interactive Interview' : 
                             currentPhase === 1.5 ? 'Auth Gate' : 'Wiggum Autonomous';
            
            document.getElementById('current-state').innerHTML = `
                <strong>Stage:</strong> ${stage.id} - ${stage.name}<br>
                <strong>Phase:</strong> ${phaseText}<br>
                <strong>OODA:</strong> ${currentOODA.toUpperCase()}<br>
                <strong>Confidence:</strong> ${(0.5 + (currentStage * 0.03)).toFixed(2)}
            `;
        }

        // =====================================================================
        // TOOLTIPS
        // =====================================================================

        function setupTooltips() {
            const tooltip = document.getElementById('tooltip');
            
            document.querySelectorAll('[data-tooltip]').forEach(el => {
                el.addEventListener('mouseenter', (e) => {
                    const text = e.target.closest('[data-tooltip]').dataset.tooltip;
                    tooltip.innerHTML = text;
                    tooltip.classList.add('visible');
                });
                
                el.addEventListener('mousemove', (e) => {
                    tooltip.style.left = e.pageX + 15 + 'px';
                    tooltip.style.top = e.pageY + 15 + 'px';
                });
                
                el.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
